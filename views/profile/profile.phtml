<?php

declare(strict_types=1);

use Jesperbeisner\Fwstats\DTO\Playtime;
use Jesperbeisner\Fwstats\Helper\Html;
use Jesperbeisner\Fwstats\Model\Player;
use Jesperbeisner\Fwstats\Model\PlayerNameHistory;
use Jesperbeisner\Fwstats\Model\PlayerProfessionHistory;
use Jesperbeisner\Fwstats\Model\PlayerRaceHistory;
use Jesperbeisner\Fwstats\Service\ViewRenderService;

/** @var ViewRenderService $this */

/** @var Player $player */
$player = $this->vars['player'];

/** @var array<string, Playtime|null> $weeklyPlaytimes */
$weeklyPlaytimes = $this->vars['weeklyPlaytimes'];

/** @var Playtime $totalPlaytime */
$totalPlaytime = $this->vars['totalPlaytime'];

/** @var Playtime $averagePlaytime */
$averagePlaytime = $this->vars['averagePlaytime'];

/** @var PlayerNameHistory[] $nameChanges */
$nameChanges = $this->vars['nameChanges'];

/** @var PlayerRaceHistory[] $raceChanges */
$raceChanges = $this->vars['raceChanges'];

/** @var PlayerProfessionHistory[] $professionChanges */
$professionChanges = $this->vars['professionChanges'];

$this->setTitle($player->name . ' - ' . $player->world->worldString());

?>
<div id="profile">
    <h1 class="title is-2">
        <a href="https://<?= $player->world->value ?>.freewar.de/freewar/internal/fight.php?action=watchuser&act_user_id=<?= $player->playerId ?>" target="_blank" class="player_profile_link">
            <?= Html::escape($player->name) ?>
        </a>
    </h1>

    <div class="card">
        <div class="card-header">
            <p class="card-header-title">
                Spielzeit der letzten 7 Tage
            </p>
        </div>
        <div class="card-content">
            <div class="content">
                <div class="table-container">
                    <table class="table is-hoverable is-fullwidth">
                        <thead>
                        <tr>
                            <td>Stunden</td>
                            <td>Minuten</td>
                            <td>Sekunden</td>
                            <td>Datum</td>
                        </tr>
                        </thead>
                        <tbody>
                        <?php $date = new DateTime('+1 day') ?>
                        <?php foreach ($weeklyPlaytimes as $playtime): ?>
                            <tr>
                                <td><?= $playtime === null ? '-' : $playtime->getHours() ?></td>
                                <td><?= $playtime === null ? '-' : $playtime->getMinutes() ?></td>
                                <td><?= $playtime === null ? '-' : $playtime->getSeconds() ?></td>
                                <td><?= $date->modify('-1 day')->format('d.m.Y') ?></td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <footer class="card-footer">
            <p class="card-footer-item">
                Gesamt: <?= $totalPlaytime->getHours() ?> h <?= $totalPlaytime->getMinutes() ?> m <?= $totalPlaytime->getSeconds() ?> s
            </p>
            <p class="card-footer-item">
                Im Durchschnitt: <?= $averagePlaytime->getHours() ?> h <?= $averagePlaytime->getMinutes() ?> m <?= $averagePlaytime->getSeconds() ?> s
            </p>
        </footer>
    </div>

    <div class="card mt-5">
        <div class="card-header">
            <p class="card-header-title">
                Namensänderungen
            </p>
        </div>
        <div class="card-content">
            <div class="content">
                <?php if (count($nameChanges) > 0): ?>
                    <div class="table-container">
                        <table class="table is-hoverable is-fullwidth">
                            <thead>
                            <tr>
                                <td>Alter Name</td>
                                <td>Neuer Name</td>
                                <td>Datum</td>
                            </tr>
                            </thead>
                            <tbody>
                            <?php foreach ($nameChanges as $nameChange): ?>
                                <tr>
                                    <td><?= $nameChange->oldName ?></td>
                                    <td><?= $nameChange->newName ?></td>
                                    <td><?= $nameChange->created->format('d.m.Y') ?></td>
                                </tr>
                            <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                <?php else: ?>
                    <p class="has-text-centered">
                        Keine Namensänderungen vorhanden.
                    </p>
                <?php endif; ?>
            </div>
        </div>
    </div>

    <div class="card mt-5">
        <div class="card-header">
            <p class="card-header-title">
                Rassenänderungen
            </p>
        </div>
        <div class="card-content">
            <div class="content">
                <?php if (count($raceChanges) > 0): ?>
                    <div class="table-container">
                        <table class="table is-hoverable is-fullwidth">
                            <thead>
                            <tr>
                                <td>Alte Rasse</td>
                                <td>Neue Rasse</td>
                                <td>Datum</td>
                            </tr>
                            </thead>
                            <tbody>
                            <?php foreach ($raceChanges as $raceChange): ?>
                                <tr>
                                    <td><?= $raceChange->oldRace ?></td>
                                    <td><?= $raceChange->newRace ?></td>
                                    <td><?= $raceChange->created->format('d.m.Y') ?></td>
                                </tr>
                            <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                <?php else: ?>
                    <p class="has-text-centered">
                        Keine Rassenänderungen vorhanden.
                    </p>
                <?php endif; ?>
            </div>
        </div>
    </div>

    <div class="card mt-5 mb-5">
        <div class="card-header">
            <p class="card-header-title">
                Berufsänderungen
            </p>
        </div>
        <div class="card-content">
            <div class="content">
                <?php if (count($professionChanges) > 0): ?>
                    <div class="table-container">
                        <table class="table is-hoverable is-fullwidth">
                            <thead>
                            <tr>
                                <td>Alter Beruf</td>
                                <td>Neuer Beruf</td>
                                <td>Datum</td>
                            </tr>
                            </thead>
                            <tbody>
                            <?php foreach ($professionChanges as $professionChange): ?>
                                <tr>
                                    <td><?= $professionChange->oldProfession ?? '-' ?></td>
                                    <td><?= $professionChange->newProfession ?? '-' ?></td>
                                    <td><?= $professionChange->created->format('d.m.Y') ?></td>
                                </tr>
                            <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                <?php else: ?>
                    <p class="has-text-centered">
                        Keine Berufsänderungen vorhanden.
                    </p>
                <?php endif; ?>
            </div>
        </div>
    </div>
</div>
